name: Update tk9.0 Purego Libs

on:
  workflow_dispatch:
    inputs:
      go_version:
        description: Go toolchain version (should match go.mod toolchain)
        required: true
        default: "1.24.11"

permissions:
  contents: write

jobs:
  update-purego-libs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Enable QEMU
        uses: docker/setup-qemu-action@v3

      - name: Build purego libs (amd64 + arm64)
        env:
          GO_VERSION: ${{ inputs.go_version }}
        run: |
          set -eux

          build_one() {
            local arch="$1"
            local platform="$2"
            local go_arch="$3"
            local embed_dir="/src/vendor/modernc.org/tk9.0/embed/linux/${arch}"
            local tk_root="/src/vendor/modernc.org/tk9.0"

            docker run --rm --platform="${platform}" \
              -v "$PWD:/src" -w /src \
              -e GO_VERSION \
              debian:10 bash -euxc '
                sed -i "s|http://deb.debian.org/debian|http://archive.debian.org/debian|g" /etc/apt/sources.list
                sed -i "s|http://deb.debian.org/debian-security|http://archive.debian.org/debian-security|g" /etc/apt/sources.list
                sed -i "s|http://security.debian.org/debian-security|http://archive.debian.org/debian-security|g" /etc/apt/sources.list
                printf "Acquire::Check-Valid-Until \"false\";\n" > /etc/apt/apt.conf.d/99no-check-valid-until

                apt-get update
                apt-get install -y \
                  git ca-certificates curl wget patch zip unzip \
                  build-essential \
                  libx11-dev libxext-dev libxrender-dev libxft-dev \
                  libfontconfig1-dev libfreetype6-dev

                curl -fsSL https://go.dev/dl/go${GO_VERSION}.linux-'"${go_arch}"'.tar.gz -o go.tar.gz
                rm -rf /usr/local/go
                tar -C /usr/local -xzf go.tar.gz
                rm go.tar.gz
                export PATH=/usr/local/go/bin:$PATH

                git config --global --add safe.directory /src
                cp /src/go.mod /tmp/go.mod
                cp /src/go.sum /tmp/go.sum
                sed -i "/^replace modernc.org\\/tk9\\.0 /d" /tmp/go.mod
                export GOMOD=/tmp/go.mod

                go mod download modernc.org/tk9.0
                TK_DIR="$(go env GOMODCACHE)/$(go list -m -f "{{.Path}}@{{.Version}}" modernc.org/tk9.0)"
                chmod -R u+w "$TK_DIR"
                git -C "$TK_DIR" init -q
                git config --global --add safe.directory "$TK_DIR"
                make -C "$TK_DIR" lib_linux_purego

                mkdir -p "'"${embed_dir}"'"
                cp -f "$TK_DIR/embed/linux/'"${arch}"'/lib.zip" "'"${embed_dir}"'/lib.zip"
                cp -f "$TK_DIR/tk_linux_'"${arch}"'.go" "'"${tk_root}"'/tk_linux_'"${arch}"'.go"
              '
          }

          build_one amd64 linux/amd64 amd64
          build_one arm64 linux/arm64 arm64

      - name: Commit changes
        run: |
          set -eux
          if [ -n "$(git status --porcelain)" ]; then
            git add vendor/modernc.org/tk9.0/embed/linux
            git add vendor/modernc.org/tk9.0/tk_linux_amd64.go
            git add vendor/modernc.org/tk9.0/tk_linux_arm64.go
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git commit -m "Update tk9.0 purego libs (Debian10)"
            git push
          else
            echo "No changes to commit."
          fi
